<!DOCTYPE html>
<html>
  <head>
    <title>Experiment_1</title>

    <!--load jspsych plugins*/-->
    <script src="jspsych/dist/jspsych.js"></script>
    <script src="jspsych/dist/plugin-preload.js"></script>
    <script src="jspsych/dist/plugin-image-button-response.js"></script>
    <script src="jspsych/dist/plugin-survey-html-form.js"></script>
    <script src="jspsych/dist/plugin-image-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-fullscreen.js"></script>
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-survey-multi-select.js"></script>

    <!--load css*/-->
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css">

  </head>

  <body></body>

  <script>

    var jsPsych = initJsPsych({
        on_finish: function(){
            jsPsych.data.displayData();}
    });


//define variables
var trial_count = 10

//------------------------------------------------------------------------------------------------------------------------------------------------
//setup stimuli info and choose trials
//------------------------------------------------------------------------------------------------------------------------------------------------
//bring in all stimuli codes
var stimuli_names = ['0000000', '0000001', '0000010', '0000011', '0000100', '0000101', '0000110', '0000111', '0001000', '0001001', 
'0001010', '0001011', '0001100', '0001101', '0001110', '0001111', '0010000', '0010001', '0010010', '0010011', '0010100', '0010101', 
'0010110', '0010111', '0011000', '0011001', '0011010', '0011011', '0011100', '0011101', '0011110', '0011111', '0100000', '0100001', 
'0100010', '0100011', '0100100', '0100101', '0100110', '0100111', '0101000', '0101001', '0101010', '0101011', '0101100', '0101101', 
'0101110', '0101111', '0110000', '0110001', '0110010', '0110011', '0110100', '0110101', '0110110', '0110111', '0111000', '0111001', 
'0111010', '0111011', '0111100', '0111101', '0111110', '0111111', '1000000', '1000001', '1000010', '1000011', '1000100', '1000101', 
'1000110', '1000111', '1001000', '1001001', '1001010', '1001011', '1001100', '1001101', '1001110', '1001111', '1010000', '1010001', 
'1010010', '1010011', '1010100', '1010101', '1010110', '1010111', '1011000', '1011001', '1011010', '1011011', '1011100', '1011101', 
'1011110', '1011111', '1100000', '1100001', '1100010', '1100011', '1100100', '1100101', '1100110', '1100111', '1101000', '1101001', 
'1101010', '1101011', '1101100', '1101101', '1101110', '1101111', '1110000', '1110001', '1110010', '1110011', '1110100', '1110101', 
'1110110', '1110111', '1111000', '1111001', '1111010', '1111011', '1111100', '1111101', '1111110', '1111111', '2000000', '2000001', 
'2000010', '2000011', '2000100', '2000101', '2000110', '2000111', '2001000', '2001001', '2001010', '2001011', '2001100', '2001101', 
'2001110', '2001111', '2010000', '2010001', '2010010', '2010011', '2010100', '2010101', '2010110', '2010111', '2011000', '2011001', 
'2011010', '2011011', '2011100', '2011101', '2011110', '2011111', '2100000', '2100001', '2100010', '2100011', '2100100', '2100101', 
'2100110', '2100111', '2101000', '2101001', '2101010', '2101011', '2101100', '2101101', '2101110', '2101111', '2110000', '2110001', 
'2110010', '2110011', '2110100', '2110101', '2110110', '2110111', '2111000', '2111001', '2111010', '2111011', '2111100', '2111101', 
'2111110', '2111111']

//create dict with all information relevant to stimuli
var stimuli = {}
for(var i = 0; i < stimuli_names.length; i++){
  var name = [stimuli_names[i]]

  //where's the ball?
  var ball_pos = parseInt(name[0])

  //can the participant see the ball?
  if(name[ball_pos + 4] == '1') {
        var ego_ball_visible = false
      } else {
        var ego_ball_visible = true
      }

  //can the participant infer the location of the ball (even if not seen?)
  if(ego_ball_visible){
    var ego_can_infer = true
  } else if((parseInt(name[4]) + parseInt(name[5]) + parseInt(name[6])) == 1){
    var ego_can_infer = true
  } else {
    var ego_can_infer = true
  }

  //can the character see the ball? (whether or not the subject knows it?)
  if(name[ball_pos + 1] == '1') {
        var alter_ball_visible = false
      } else {
        var alter_ball_visible = true
      }

  //can the character infer the location of the ball (even if not seen?)
  if(alter_ball_visible){
    var alter_can_infer = true
  } else if((parseInt(name[1]) + parseInt(name[2]) + parseInt(name[3])) <= 1){
    var alter_can_infer = true
  } else {
    var alter_can_infer = false
  }


  //can both the character and the subject see the ball? 
  if(ego_ball_visible & alter_ball_visible){
      var collective_ball_visible = true
    } else {
      var collective_ball_visible = false
    }

  //can both infer the location of the ball?
  if(ego_can_infer & alter_can_infer){
    var collective_can_infer = true
  } else {
    var collective_can_infer = false
  }

  //Is there a rational location the subject should guess the character will search?
  if(collective_can_infer){
    var rational_guess = true
  } else {
    var rational_guess = false
  }

  //Where might the character search?
  var search_locations = []
  if(alter_can_infer){ //if the character can infer the ball location, they'll search there
    search_locations = [ball_pos]
  } else { //else, select from among the alter occluded positions
    if(parseInt(name[1])==1){
      search_locations.push(0)
    }
    if(parseInt(name[2])==1){
      search_locations.push(1)
    }
    if(parseInt(name[3])==1){
      search_locations.push(2)
    }
  }
  search_locations = jsPsych.randomization.shuffle(search_locations) //shuffle options, the answer will be defined as the first in the list



  stimuli[name] = {
    filepath: 'stimuli/' + name + '.jpg',
    ball_pos: ball_pos,
    ego_ball_visible: ego_ball_visible,
    ego_can_infer: ego_can_infer,
    alter_ball_visible: alter_ball_visible,
    alter_can_infer: alter_can_infer,
    collective_ball_visible: collective_ball_visible,
    collective_can_infer: collective_can_infer,
    alter_can_infer: alter_can_infer,
    search_locations: search_locations
  }
}

//define trial sequence
key_trials = []
other_trials = []
for(var i=0; i<stimuli_names.length; i++){
  var name = stimuli_names[i]
  if(name[1] + name[2] + name[3] == 3){
  key_trials.push(stimuli_names[i])
  key_trials.push(stimuli_names[i])
  } else {
  other_trials.push(stimuli_names[i])
  }
}
other_trials = jsPsych.randomization.shuffle(other_trials).slice(0,other_trials.length/2)

var trials = key_trials.concat(other_trials)
trials = jsPsych.randomization.shuffleNoRepeats(trials)
console.log(trials.length)
trials = trials.slice(0,trial_count)


//------------------------------------------------------------------------------------------------------------------------------------------------
//start timeline
//------------------------------------------------------------------------------------------------------------------------------------------------

    const window_width = window.innerWidth
    var timeline = []



//------------------------------------------------------------------------------------------------------------------------------------------------
//Instructions
//------------------------------------------------------------------------------------------------------------------------------------------------
var intro = []
var intro_text = [ //create introductory text
   "Welcome! Please read the following instructions carefully.",
   "<img src= stimuli/character.jpg> </img> <p> This is Sam. </p>",
   "<img src= stimuli/character.jpg> </img> <p> In this experiment, you will complete a task along with Sam.</p>",
   "<img src= stimuli/1000000.jpg> </img> <p>Throughout the experiment, Sam will be searching for a red ball, which will be placed in one of three baskets.</p>",
   "<img src= stimuli/1000000.jpg> </img> <p>Sam is only allowed to select one basket to search for the ball.</p>",
   "<img src= stimuli/1000000.jpg> </img> <p>Your job will be to predict which basket Sam will choose to search for the ball.</p>",
   "<img src= stimuli/1101000.jpg> </img> <p>Sometimes, Sam will be able to see the ball! These trials are easy for Sam.</p>",
   "<img src= stimuli/1111000.jpg> </img> <p>Other times, Sam will not be able to see the ball.</p>",
   "<img src= stimuli/1111000.jpg> </img> <p>Regardless, you will need to predict which basket Sam will choose.</p>",
   "<img src= stimuli/1111000.jpg> </img> <p>You will use your keyboard to respond. Throughout the experiment, please be ready to use your 'f', 'g', and 'h' keys to select the corresponding basket.</p>",
   "Before we begin, let's practice!"]


 var experiment_intro = { //create instructions trials
   type: jsPsychInstructions,
   pages: intro_text,
   show_clickable_nav: true,
   data: {trial: 'intro'}
 };

intro.push(experiment_intro)


 //add a comprehension check
 var comprehension_quiz = {
  type: jsPsychImageKeyboardResponse,
  timeline: [
    {
      prompt: "<p> Where will Sam search for the ball?",
      choices: ["arrowleft", "arrowdown", "arrowright"],
      stimulus: "stimuli/0000011.jpg",
      data: {correct_response: 'arrowleft'},
    },
    {
      prompt: function(){
              if(jsPsych.data.getLastTrialData().values()[0].accuracy) {
                return "<p> ✅ Correct! ✅</p> (press 'space' to continue)"
              } else {
                return "<p> ❌ Incorrect! ❌</p> (press 'space' to continue)"
              }
            },
      stimulus: "stimuli/00000110.jpg",
      choices: [" "],
      data: {correct_response: ' '}
    },    
    {
      prompt: "<p> Where will Sam search for the ball?",
      choices: ["arrowleft", "arrowdown", "arrowright"],
      stimulus: "stimuli/1100010.jpg",
      data: {correct_response: 'arrowdown'}
    },
    {
      prompt: function(){
              if(jsPsych.data.getLastTrialData().values()[0].accuracy) {
                return "<p> ✅ Correct! ✅</p> (press 'space' to continue)"
              } else {
                return "<p> ❌ Incorrect! ❌</p> (press 'space' to continue)"
              }
            },
      stimulus: "stimuli/11000101.jpg",
      choices: [" "],
      data: {correct_response: ' '}
    }],
  data: {
      trial: 'comprehension_quiz'
    },
  on_finish: function(data){
      var accuracy = false
      if(data.correct_response == data.response){
        accuracy = true
      }
      data.accuracy = accuracy
    }
}
intro.push(comprehension_quiz)

//if one or more questions are answered incorrectly, play this message
 var fail_message = {
   type: jsPsychHtmlButtonResponse,
   stimulus: "<p> Oops! You have answered one or more questions incorrectly.</p>" +
             "<p> Please Review the instructions again before continuing with the experiment </p>",
   choices: ["Review Instructions"],
   data: {
     trial: 'fail_message',
     accuracy: false
   }
 }

 //define conditional for the error message
 var conditional_fail = {
    timeline: [fail_message],
    conditional_function: function(){
        // get the data from the previous trials,
        // if any were incorrect, display fail message and set data.loop = true
        var data = jsPsych.data.get().last(4).values();
        if(data[0].accuracy && data[2].accuracy){
            return false;
        } else {
            return true;
        }
    } 
}
intro.push(conditional_fail)
 
//if error message is triggered, loop back through the first part of the instructions
  var instructions = {
    timeline: intro,
    loop_function: function(data){
       if(data.last(1).values()[0].trial=='fail_message'){
            return true
        } else {
            return false
        }
    }
}
timeline.push(instructions)

 var expt_will_begin = {
   type: jsPsychHtmlButtonResponse,
   stimulus: "The experiment will now begin.",
   choices: ["Continue"]
 }

 timeline.push(expt_will_begin)

//------------------------------------------------------------------------------------------------------------------------------------------------
//Main trial Sequence
//------------------------------------------------------------------------------------------------------------------------------------------------
    for(var i = 0; i < trials.length; i++){

      var stimulus = trials[i]
      var character_choice = jsPsych.randomization.shuffle(stimuli[stimulus]['search_locations'])[0]

      var prediction_trial = {
      type: jsPsychImageKeyboardResponse,
      prompt: "<p> Where will Sam search for the ball? </p?",
      stimulus: stimuli[stimulus]['filepath'],
      choices: ["arrowleft", "arrowdown", "arrowright"],
      stimulus_width: window_width*0.8,
      data: {
        trial: "prediciton_trial",
        character_choice: character_choice,
        stimulus_dict: stimuli[stimulus]
      },
      on_finish: function(data){
        if(data.response == "arrowleft") {
          data.response = 0
        } else if(data.response == "arrowdown") {
          data.response = 1
        } else if(data.response == "arrowright") {
          data.response = 2
        }

        if(data.response == data.character_choice){
          data.accuracy = true
        } else {
          data.accuracy = false
        }
      }
      }

      var feedback = {
      type: jsPsychImageKeyboardResponse,
      prompt: function(){
        if(jsPsych.data.getLastTrialData().values()[0].accuracy){
          return "<p> ✅ Correct! ✅</p> (press 'space' to continue)"
        } else {
          return "<p> ❌ Incorrect! ❌</p> (press 'space' to continue)"
        }
      },
      stimulus: "stimuli/" + stimulus + String(character_choice) + ".jpg",
      choices: [" "],
      stimulus_width: window_width*0.8,
      data: {
        trial: "prediciton_trial",
        character_choice: stimuli[stimulus]['search_locations'][0]
      }
    }
    
    timeline.push(prediction_trial)
    timeline.push(feedback)
    }

  jsPsych.run(timeline);

</script>
</html>